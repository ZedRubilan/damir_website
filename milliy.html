<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Миллий Тест - Выбор варианта - Rus.mastery</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Styles adapted from index.TXT */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3f37c9;
            --secondary: #ff8c00;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --border-radius: 12px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px; /* Adjusted for quiz focus */
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Header styles (simplified for quiz page) */
        header {
            background-color: #ffffff;
            padding: 15px 0;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
             margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo-image {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-weight: 800;
        }

         .logo span {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .logo span.accent {
            color: var(--secondary);
            -webkit-text-fill-color: var(--secondary);
        }

        /* Variant Selection Styles */
        #variant-selection-container {
            text-align: center;
            padding: 40px 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-top: 40px;
        }
        #variant-selection-container h2 {
            margin-bottom: 30px;
            color: var(--primary-dark);
        }
        .variant-button {
            display: inline-block;
            padding: 18px 35px;
            margin: 10px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 18px;
            text-decoration: none;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
            min-width: 200px;
        }
        .variant-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }

        /* Collapsible Passage Styles */
        .passage-toggle-container {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .toggle-passage-btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .toggle-passage-btn:hover {
            background-color: #e67e00;
        }
        .toggle-passage-btn .fas {
             transition: transform 0.3s ease;
        }
         .toggle-passage-btn.expanded .fa-chevron-down {
             transform: rotate(180deg);
         }
        .passage-content {
            display: none; /* Hide by default */
            background-color: #fdfdfe;
            border: 1px solid var(--gray-light);
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            max-height: 500px; /* Keep max-height for scroll */
            overflow-y: auto; /* Add scroll if content exceeds max-height */
        }
        .passage-content.visible {
             display: block; /* Show when visible class is added */
        }

        .passage-content h4 {
            margin-bottom: 10px;
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1.0em;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--gray-light);
        }
        .passage-content p {
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            color: var(--dark);
        }

        /* Quiz Specific Styles */
        #quiz-container {
            margin-bottom: 30px;
        }

        .quiz-question {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-light);
            transition: var(--transition);
        }

        .quiz-question:hover {
             box-shadow: var(--shadow-md);
             transform: translateY(-3px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .question-number {
            font-weight: 700;
            color: var(--primary);
            font-size: 18px;
        }

        .question-points {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary);
            background-color: rgba(255, 140, 0, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 16px;
            white-space: pre-wrap;
        }
         .question-text .text-label {
             font-weight: 600;
             color: var(--primary-dark);
             display: block;
             margin-bottom: 5px;
             font-size: 0.9em;
         }

        .options-list {
            list-style: none;
            padding-left: 0;
            margin-top: 20px;
        }

        .options-list li {
            margin-bottom: 12px;
        }

        .options-list label {
            display: block;
            background-color: var(--gray-light);
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .options-list label:hover {
            background-color: #dde2e7;
        }

        .options-list input[type="radio"] {
            display: none;
        }

         .options-list input[type="radio"]:checked + label {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
            color: var(--primary-dark);
            font-weight: 600;
        }

        /* Input styles for fill-in-the-blank */
        .fill-in-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 15px;
            margin-top: 10px;
            transition: var(--transition);
        }
         .fill-in-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
         }

        /* Matching styles */
        .matching-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
             margin-top: 20px;
        }
        .matching-column {
            flex: 1;
            min-width: 150px;
        }
         .matching-column ul {
            list-style: none;
            padding: 0;
         }
         .matching-column li {
            padding: 5px 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
         }
         .matching-column strong {
             display: block;
             margin-bottom: 10px;
             color: var(--dark);
             font-weight: 600;
         }
         .matching-column select {
             width: auto;
             min-width: 120px;
             padding: 5px 8px;
             margin-left: 10px;
             border-radius: 4px;
             border: 1px solid var(--gray);
         }


        /* Submit Button */
        #submit-btn {
            display: block;
            width: 100%;
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 16px;
            text-decoration: none;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
            text-align: center;
            margin-top: 30px;
        }

        #submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }
         #submit-btn:disabled {
             background: var(--gray);
             cursor: not-allowed;
             box-shadow: none;
             transform: none;
         }

        /* Results Styles */
        #results-container {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-top: 40px;
        }

        #results-summary {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        #results-summary h2 {
             font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
         #results-summary p {
            font-size: 18px;
            color: var(--dark);
         }

        .result-item {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
        }

        .result-item.correct {
            background-color: rgba(76, 175, 80, 0.08);
            border-left: 5px solid var(--success);
        }

        .result-item.incorrect {
            background-color: rgba(244, 67, 54, 0.08);
            border-left: 5px solid var(--danger);
        }

        .result-item .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
         .result-item .question-text .text-label {
              font-weight: 600;
             color: var(--primary-dark);
             display: block;
             margin-bottom: 5px;
             font-size: 0.9em;
         }


        .result-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .result-details strong {
            font-weight: 600;
        }

        .correct-answer {
            color: var(--success);
            font-weight: bold;
        }
        .incorrect-answer {
             color: var(--danger);
             font-weight: bold;
        }

         .result-details ul {
             list-style: none;
             padding-left: 15px;
             margin-top: 5px;
         }
         .result-details li {
             margin-bottom: 5px;
         }


        .hidden {
            display: none !important;
        }

        /* Responsive */
         @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 0 15px;
            }
             .header-content {
                flex-direction: column;
                gap: 10px;
             }
             .quiz-question {
                 padding: 15px;
             }
             .question-text {
                 font-size: 15px;
             }
             .options-list label {
                 padding: 10px 15px;
             }
             #submit-btn {
                 font-size: 15px;
                 padding: 12px 20px;
             }
             #results-container {
                 padding: 20px;
             }
              #variant-selection-container {
                 padding: 20px 15px;
             }
             .variant-button {
                 font-size: 16px;
                 padding: 15px 25px;
                 min-width: 180px;
             }
             #results-summary h2 {
                 font-size: 24px;
             }
             .matching-container {
                 flex-direction: column;
             }
              .passage-content {
                 font-size: 13px;
             }
             .toggle-passage-btn {
                 font-size: 12px;
             }
         }

    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <a href="index.html" class="logo"> <div class="logo-image">R</div>
                <span>Rus.<span class="accent">mastery</span></span>
            </a>
             </div>
    </header>

    <main>
        <div class="container">
            <h1 id="main-title" style="text-align: center; margin-bottom: 30px; color: var(--primary-dark);">Миллий Сертификат - Выбор варианта</h1>

            <div id="variant-selection-container">
                <h2>Выберите вариант теста:</h2>
                <button class="variant-button" data-variant="1">Вариант 1</button>
            </div>

            <form id="quiz-form" class="hidden">
                <div id="quiz-container">
                    <p style="text-align: center; padding: 20px; color: var(--gray);">Загрузка вопросов...</p>
                </div>
                <button type="submit" id="submit-btn" disabled>Завершить тест</button>
            </form>

            <div id="results-container" class="hidden">
                <div id="results-summary">
                    <h2>Результаты Теста</h2>
                    <p id="score-display">Ваш результат: 0 / 0 баллов</p>
                </div>
                <div id="detailed-results">
                    </div>
                 <button id="retry-button" style="display: block; margin: 30px auto 0; padding: 10px 20px; background-color: var(--secondary); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600;">Выбрать другой вариант</button>
            </div>
        </div>
    </main>

    <script>
        // --- Constants for Local Storage Keys ---
        const LS_STATE_KEY = 'milliyQuiz_state';
        const LS_VARIANT_KEY = 'milliyQuiz_variantId';
        const LS_ANSWERS_KEY = 'milliyQuiz_answers';
        const LS_QUESTIONS_KEY = 'milliyQuiz_questionIds';
        const LS_SCORE_KEY = 'milliyQuiz_score';
        const LS_TOTAL_SCORE_KEY = 'milliyQuiz_totalScore';

        // --- Reading Passages Data ---
        const readingPassages = {
            'moscow': {
                title: "Москва — столица России",
                text: `Москва — столица Российской Федерации и крупнейший город страны. Она расположена в центральной части России, на реке Москве, и является культурным, экономическим и политическим центром страны. История Москвы начинается с 12 века, когда в 1147 году был основан первый московский кремль. В те времена Москва была маленьким торговым поселением, но постепенно росла и становилась важным политическим и культурным центром.
С течением времени Москва неоднократно переживала войны и разрушения, но каждый раз восстанавливалась и укрепляла свои позиции. В 15 веке Московское княжество стало одним из крупнейших государств в Восточной Европе, а в 1547 году Иван Грозный принял титул царя и сделал Москву центром нового Российского государства.
Сейчас Москва — это огромный мегаполис с населением более 12 миллионов человек. В городе сосредоточены главные органы государственной власти, крупнейшие компании, научные учреждения, а также культурные и исторические памятники. Здесь находится Красная площадь, Кремль, знаменитый храм Василия Блаженного, а также множество музеев, театров и галерей.
Москва также известна своими многочисленными парками, скверами и зелеными зонами, которые делают жизнь в городе более комфортной. Московский метрополитен, один из самых красивых и удобных в мире, ежедневно перевозит миллионы пассажиров.
Город продолжает развиваться, и его роль на мировой арене только увеличивается. Москва является одним из главных культурных и деловых центров Европы и мира.`,
                questionIds: [18, 19, 20, 21, 22]
            },
            'biryuk': {
                title: '"Бирюк" (Иван Тургенев)',
                text: `Проводник остановился. «Вот мы и дома, барин», − промолвил он спокойным голосом. Калитка заскрипела, несколько щенков дружно залаяло. Я поднял голову и при свете молнии увидал небольшую избушку посреди обширного двора, обнесённого плетнём. Из одного окошечка тускло светил огонёк. Лесник довёл лошадь до крыльца и застучал в дверь. «Сичас, сичас!» − раздался тоненький голосок, послышался топот босых ног, засов заскрипел, и девочка лет двенадцати, в рубашонке, подпоясанная покромкой, с фонарём в руке, показалась на пороге.
Изба лесника состояла из одной комнаты, закоптелой, низкой и пустой, без полатей и перегородок. Изорванный тулуп висел на стене. На лавке лежало одноствольное ружьё, в углу валялась груда тряпок; два больших горшка стояли возле печки. Лучина горела на столе, печально вспыхивая и погасая. На самой середине избы висела люлька, привязанная к концу длинного шеста. Девочка погасила фонарь, присела на крошечную скамейку и начала правой рукой качать люльку... Я посмотрел кругом − сердце во мне заныло: не весело войти ночью в мужицкую избу. Ребёнок в люльке дышал тяжело и скоро.
Дверь заскрипела, и лесник шагнул, нагнув голову, через порог. Он поднял фонарь с полу, подошёл к столу и зажёг светильню. Я посмотрел на него. Редко мне случалось видеть такого молодца. Он был высокого роста, плечист и сложен на славу. Из-под мокрой рубашки выпукло выставлялись его могучие мышцы. Чёрная курчавая борода закрывала до половины его суровое и мужественное лицо; из-под сросшихся широких бровей смело глядели небольшие карие глаза. Он слегка упёрся руками в бока и остановился передо мною.
Он достал из-за пояса топор, присел на пол и начал колоть лучину. − Аль у тебя хозяйки нет? − спросил я его. − Нет, − отвечал он и сильно махнул топором. − Умерла, знать? − Нет... да... умерла, − прибавил он и отвернулся.
Я замолчал; он поднял глаза и посмотрел на меня. − С прохожим мещанином сбежала, − произнёс он с жестокой улыбкой.
Девочка потупилась; ребёнок проснулся и закричал; девочка подошла к люльке.
...
Мы выбрались, наконец, из оврага. «Подождите здесь», − шепнул мне лесник, нагнулся и, подняв ружьё кверху, исчез между кустами. Я стал прислушиваться с напряжением. Сквозь постоянный шум ветра чудились мне невдалеке слабые звуки: топор осторожно стучал по сучьям, колёса скрипели, лошадь фыркала... «Куда? стой!» − загремел вдруг железный голос... Другой голос закричал жалобно, по-заячьи... Началась борьба. У срубленного дерева, на земле, копошился лесник; он держал под собою вора и закручивал ему кушаком руки на спину.
Я увидал мужика, мокрого, в лохмотьях, с длинной растрёпанной бородой. Дрянная лошадёнка, до половины закрытая угловатой рогожкой, стояла тут же вместе с тележным ходом. Лесник не говорил ни слова; мужик тоже молчал и только головой потряхивал.`,
                questionIds: [23, 24, 25, 26, 27]
            },
            'yesenin': {
                 title: 'С. Есенин "Не жалею, не зову, не плачу..."',
                 text: `Не жалею, не зову, не плачу,
Все пройдет, как с белых яблонь дым.
Увяданья золотом охваченный,
Я не буду больше молодым.`,
                 questionIds: [28, 29, 30, 31, 32]
            },
            'lermontov': {
                title: 'М. Лермонтов (Отрывок)',
                text: `Как мальчик кудрявый, резва,
Нарядна, как бабочка летом.
Значенья пустого слова,
В устах ее полны приветом.`,
                questionIds: [47, 48]
            }
        };


        // --- Questions Data (for Variant 1) ---
        // This represents the full pool of questions for variant 1
        const allVariant1Questions = [
             // Multiple Choice (1-17)
            { id: 1, points: 1.1, type: 'multiple-choice', text: '1. Что такое фонема?', options: ['Минимальная смыслоразличительная единица языка', 'Минимальная синтаксическая единица', 'Минимальная морфологическая единица', 'Минимальная интонационная единица'], correctAnswer: 'A' },
            { id: 2, points: 1.7, type: 'multiple-choice', text: '2. Выберите синоним к слову "амбиция":', options: ['Скромность', 'Честолюбие', 'Безразличие', 'Щедрость'], correctAnswer: 'B' },
            { id: 3, points: 1.1, type: 'multiple-choice', text: '3. Какое слово образовано с помощью приставки?', options: ['Бесстрашный', 'Домик', 'Столик', 'Лесной'], correctAnswer: 'A' },
            { id: 4, points: 1.7, type: 'multiple-choice', text: '4. Вставьте пропущенные буквы: кл_нч_вый', options: ['е, и', 'я, е', 'и, е', 'е, е'], correctAnswer: 'C' },
            { id: 5, points: 1.1, type: 'multiple-choice', text: '5. Выберите синоним к слову "красивый":', options: ['Уродливый', 'Прекрасный', 'Грязный', 'Шумный'], correctAnswer: 'B' },
            { id: 6, points: 1.7, type: 'multiple-choice', text: '6. Какое причастие является действительным настоящего времени?', options: ['Летящий', 'Летевший', 'Летавший', 'Летящийся'], correctAnswer: 'A' },
            { id: 7, points: 2.5, type: 'multiple-choice', text: '7. Какое слово является наречием?', options: ['Важно', 'Высота', 'Важный', 'Важность'], correctAnswer: 'A' },
            { id: 8, points: 1.7, type: 'multiple-choice', text: '8. Какое предложение является назывным?', options: ['Темнеет.', 'Вечер, покой, тишина.', 'Мне нужно идти.', 'Стук в дверь.'], correctAnswer: 'B' },
            { id: 9, points: 2.5, type: 'multiple-choice', text: '9. Какой тип сложного предложения представлен?\nСолнце зашло, и на небе появились звёзды.', options: ['Сложносочинённое', 'Сложноподчинённое', 'Бессоюзное', 'Смешанное'], correctAnswer: 'A' },
            { id: 10, points: 1.7, type: 'multiple-choice', text: '10. В каком предложении правильно расставлены знаки препинания?', options: ['Он сказал что придёт завтра.', 'Он сказал, что придёт завтра.', 'Он, сказал что, придёт завтра.', 'Он сказал что, придёт, завтра.'], correctAnswer: 'B' },
            { id: 11, points: 1.7, type: 'multiple-choice', text: '11. Какой стиль речи используется в научных статьях и учебниках?', options: ['Разговорный', 'Научный', 'Публицистический', 'Официально-деловой'], correctAnswer: 'B' },
            { id: 12, points: 2.5, type: 'multiple-choice', text: '12. Укажите правильный вариант: Какой глагол означает «принять участие в процессе»?', options: ['Абонировать', 'Абонент', 'Абонемент', 'Абонирующий'], correctAnswer: 'A' },
            { id: 13, points: 1.7, type: 'multiple-choice', text: '13. Кто сказал: «Счастливые часов не наблюдают»?', options: ['Александр Пушкин', 'Михаил Лермонтов', 'Александр Грибоедов', 'Николай Гоголь'], correctAnswer: 'C' },
            { id: 14, points: 2.5, type: 'multiple-choice', text: '14. Кто из персонажей был описан как «молодой человек с гордой осанкой, с печальным выражением лица и в темном сюртуке»?', options: ['Онегин (Из произведения А.С. Пушкина «Евгений Онегин»)', 'Печорин (Из произведения М.Ю. Лермонтова «Герой нашего времени»)', 'Базаров (Из произведения И.С. Тургенева «Отцы и дети»)', 'Чацкий (Из произведения А.С. Грибоедова «Горе от ума»)'], correctAnswer: 'B' },
            { id: 15, points: 2.5, type: 'multiple-choice', text: '15. Кто сказал: "Человек есть то, что он читает"?', options: ['Л.Н. Толстой', 'М.В. Ломоносов', 'Ф.М. Достоевский', 'И.А. Бродский'], correctAnswer: 'D' },
            { id: 16, points: 1.1, type: 'multiple-choice', text: '16. Какой троп используется в выражении "светлая улыбка"?', options: ['Метафора', 'Олицетворение', 'Символ', 'Антитеза'], correctAnswer: 'A' },
            { id: 17, points: 1.1, type: 'multiple-choice', text: '17. Что является примером гиперболы?', options: ['"Он был как дуб"', '"Далеко-далеко, на краю света..."', '"Забытые дороги, забытые имена..."', '"Весь мир обрушился на него"'], correctAnswer: 'D' },

            // Reading: Москва (18-22)
            { id: 18, points: 1.1, type: 'multiple-choice', text: '18. Когда был основан Московский кремль?', options: ['В 1147 году', 'В 1453 году', 'В 1500 году', 'В 1600 году'], correctAnswer: 'A', passageKey: 'moscow' },
            { id: 19, points: 1.1, type: 'multiple-choice', text: '19. Какая река протекает через Москву?', options: ['Волга', 'Москва', 'Нева', 'Днепр'], correctAnswer: 'B', passageKey: 'moscow' },
            { id: 20, points: 1.1, type: 'multiple-choice', text: '20. Какой титул принял Иван Грозный в 1547 году?', options: ['Император', 'Царь', 'Великий князь', 'Князь Московский'], correctAnswer: 'B', passageKey: 'moscow' },
            { id: 21, points: 1.1, type: 'multiple-choice', text: '21. Что делает Московский метрополитен одним из самых удобных в мире?', options: ['Низкие цены на билеты', 'Красивая архитектура станций', 'Высокая скорость движения поездов', 'Большое количество линий и станций'], correctAnswer: 'D', passageKey: 'moscow' },
            { id: 22, points: 1.1, type: 'multiple-choice', text: '22. Какие исторические памятники можно увидеть на Красной площади?', options: ['Храм Василия Блаженного', 'Памятник Петру I', 'Кремль и мавзолей Ленина', 'Все перечисленные памятники'], correctAnswer: 'D', passageKey: 'moscow' },

             // Reading: Бирюк (23-27)
            { id: 23, points: 1.7, type: 'multiple-choice', text: '23. К кому обращается проводник в начале текста?', options: ['К леснику', 'К барину', 'К девочке', 'К крестьянину'], correctAnswer: 'B', passageKey: 'biryuk' },
            { id: 24, points: 1.7, type: 'multiple-choice', text: '24. Как выглядит лесник?', options: ['Худощавый, с седой бородой', 'Высокий, плечистый, с карими глазами', 'Полный мужчина с рыжими волосами', 'Маленького роста, с аккуратной внешностью'], correctAnswer: 'B', passageKey: 'biryuk' },
            { id: 25, points: 1.7, type: 'multiple-choice', text: '25. Каким приёмом описан момент появления дома лесника?', options: ['Аллюзия', 'Контраст', 'Гипербола', 'Пейзажная зарисовка'], correctAnswer: 'D', passageKey: 'biryuk' },
            { id: 26, points: 2.5, type: 'multiple-choice', text: '26. Какой основной конфликт показан в рассказе?', options: ['Человек и природа', 'Человек и власть', 'Человек и общество', 'Человек и судьба'], correctAnswer: 'C', passageKey: 'biryuk' },
            { id: 27, points: 2.5, type: 'multiple-choice', text: '27. Какой литературный стиль использует Тургенев в этом произведении?', options: ['Реализм', 'Символизм', 'Романтизм', 'Барокко'], correctAnswer: 'A', passageKey: 'biryuk' },

             // Reading: Есенин (28-32)
            { id: 28, points: 1.7, type: 'multiple-choice', text: '28. Как называется род литературы, к которому относится данное произведение?', options: ['Проза', 'Поэзия', 'Драма', 'Эпос'], correctAnswer: 'B', passageKey: 'yesenin' },
            { id: 29, points: 1.7, type: 'multiple-choice', text: '29. С каким литературным направлением связано творчество С. Есенина?', options: ['акмеизм', 'реализм', 'футуризм', 'имажинизм'], correctAnswer: 'D', passageKey: 'yesenin' },
            { id: 30, points: 1.7, type: 'multiple-choice', text: '30. Укажите размер стихосложения.', options: ['анапест', 'хорей', 'ямб', 'амфибрахий'], correctAnswer: 'C', passageKey: 'yesenin' },
            { id: 31, points: 1.7, type: 'multiple-choice', text: '31. Какой художественный приём использует поэт в строках?\nУвяданья золотом охваченный,\nЯ не буду больше молодым.', options: ['метафора', 'аллегория', 'инверсия', 'антитеза'], correctAnswer: 'A', passageKey: 'yesenin' },
            { id: 32, points: 2.5, type: 'multiple-choice', text: '32. определите тему стихотворения.', options: ['Любовь', 'Воспоминания о молодости', 'Природа', 'Смерть'], correctAnswer: 'B', passageKey: 'yesenin' },

            // Matching (33-35)
             {
                 id: 33, points: 5.1, type: 'matching',
                 text: '33-35. Соотнесите персонажей романа Н.В. Гоголя «Мертвые души» с их характеристиками:',
                 items: { 'Чичиков': '?', 'Манилов': '?', 'Ноздрев': '?' },
                 options: ['главный герой', 'комический образ', 'идеалистический персонаж', 'сатирический персонаж', 'положительный герой', 'отрицательный герой'],
                 correctAnswer: { 'Чичиков': 'отрицательный герой', 'Манилов': 'идеалистический персонаж', 'Ноздрев': 'сатирический персонаж' }
             },

            // Fill-in-the-blank (36-45)
            { id: 36, points: 1.7, type: 'fill-in', text: '36. Подберите синоним к слову "успех" и запишите правильный ответ.', correctAnswer: 'прогресс' },
            { id: 37, points: 1.7, type: 'fill-in', text: '37. Напишите значение фразеологизма одним словом: Как снег на голову', correctAnswer: 'неожиданно' },
            { id: 38, points: 1.7, type: 'fill-in', text: '38. Подберите пропущенный производный предлог и напишите его:\nМы встретились с ним ... успешного завершения дела.', correctAnswer: 'после' },
            { id: 39, points: 1.7, type: 'fill-in', text: '39. Найдите ошибку в употреблении паронимов. Напишите исправленное слово:\nВ музее представлена глинистая посуда древних славян.', correctAnswer: 'глиняная' },
            { id: 40, points: 0.8, type: 'fill-in', text: '40. Определите способ словообразования слов: Машиностроение, Госслужащий, Телеграмма', correctAnswer: 'сложение' },
            { id: 41, points: 0.9, type: 'fill-in', text: '41. Напишите часть речи, от которой образованы слова: Машиностроение, Госслужащий, Телеграмма', correctAnswer: 'существительное' },
            { id: 42, points: 0.8, type: 'fill-in', text: '42. Вставьте вместо точек подходящий по смыслу союз (союзное слово):\nГоры Узбекистана, ... так удачно сочетаются величие и красота, являются для республики ещё и богатейшей кладовой природы', correctAnswer: 'в которых' },
            { id: 43, points: 0.9, type: 'fill-in', text: '43. Определите вид придаточного в предложении из вопроса 42.', correctAnswer: 'определительное' },
            { id: 44, points: 0.8, type: 'fill-in', text: '44. Укажите жанр произведения А.П.Чехова «Вишневый сад».', correctAnswer: 'пьеса' },
            { id: 45, points: 0.9, type: 'fill-in', text: '45. Признаки какого литературного течения имеют место в произведении «Вишневый сад»?', correctAnswer: 'реализм' },

            // Lermontov snippet questions (47-48)
            { id: 47, points: 0.8, type: 'fill-in', text: '47. Какой приём использовал поэт в приведённом отрывке?', correctAnswer: 'сравнение', passageKey: 'lermontov' },
            { id: 48, points: 0.9, type: 'fill-in', text: '48. Определите стихотворный размер отрывка.', correctAnswer: 'хорей', passageKey: 'lermontov' },

             // Dostoevsky questions (49-50)
             { id: 49, points: 0.8, type: 'fill-in', text: '49. К какому литературному направлению относится творчество М.Ф.Достоевского?', correctAnswer: 'реализм' },
             { id: 50, points: 0.9, type: 'fill-in', text: '50. Основным жанром этого направления, отразившимся в творчестве М.Ф.Достоевского, считается...', correctAnswer: 'роман' },
        ];

        // --- Quiz Logic ---
        const variantSelectionContainer = document.getElementById('variant-selection-container');
        const quizForm = document.getElementById('quiz-form');
        const quizContainer = document.getElementById('quiz-container');
        const resultsContainer = document.getElementById('results-container');
        const detailedResultsContainer = document.getElementById('detailed-results');
        const scoreDisplay = document.getElementById('score-display');
        const submitButton = document.getElementById('submit-btn');
        const retryButton = document.getElementById('retry-button');
        const mainTitle = document.getElementById('main-title');


        let selectedQuestions = []; // Holds the actual question objects for the current attempt
        let currentAnswers = {}; // Holds the user's answers for the current attempt
        let totalPossibleScore = 0;
        const questionsToDisplay = 45;

        // --- Utility functions for Local Storage ---
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        }

        function getFromLocalStorage(key) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch (e) {
                console.error("Error reading from localStorage", e);
                return null;
            }
        }

        function removeFromLocalStorage(key) {
             try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error("Error removing from localStorage", e);
            }
        }

        function clearQuizState() {
            removeFromLocalStorage(LS_STATE_KEY);
            removeFromLocalStorage(LS_VARIANT_KEY);
            removeFromLocalStorage(LS_ANSWERS_KEY);
            removeFromLocalStorage(LS_QUESTIONS_KEY);
            removeFromLocalStorage(LS_SCORE_KEY);
            removeFromLocalStorage(LS_TOTAL_SCORE_KEY);
            // Reset global variables
            selectedQuestions = [];
            currentAnswers = {};
            totalPossibleScore = 0;
        }

        // Function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Function to display the variant selection screen
        function displayVariantSelection() {
            mainTitle.textContent = 'Миллий Сертификат - Выбор варианта';
            variantSelectionContainer.classList.remove('hidden');
            quizForm.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            quizContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">Загрузка вопросов...</p>'; // Reset quiz container
            submitButton.disabled = true;
        }

        // Function to start the quiz for the selected variant
        function startQuiz(variantId) {
            if (variantId === '1') {
                clearQuizState(); // Clear any previous state before starting anew
                mainTitle.textContent = 'Миллий Сертификат - Тест (Вариант 1)';
                variantSelectionContainer.classList.add('hidden');
                quizForm.classList.remove('hidden');
                resultsContainer.classList.add('hidden');

                // --- Select and Save Questions ---
                let allQuestionsCopy = [...allVariant1Questions];
                shuffleArray(allQuestionsCopy);
                selectedQuestions = allQuestionsCopy.slice(0, questionsToDisplay);
                const selectedQuestionIds = selectedQuestions.map(q => q.id);

                // Save initial state
                saveToLocalStorage(LS_STATE_KEY, 'in-progress');
                saveToLocalStorage(LS_VARIANT_KEY, variantId);
                saveToLocalStorage(LS_QUESTIONS_KEY, selectedQuestionIds);
                saveToLocalStorage(LS_ANSWERS_KEY, {}); // Start with empty answers

                loadQuizQuestionsUI(selectedQuestions, {}); // Load UI with empty answers
            } else {
                console.error("Unknown variant selected:", variantId);
                alert("Выбран неизвестный вариант.");
            }
        }

        // Function to load and display quiz UI based on question data and answers
        function loadQuizQuestionsUI(questions, answers) {
            quizContainer.innerHTML = ''; // Clear loading message
            totalPossibleScore = 0;

            // Calculate total score
            questions.forEach(q => {
                totalPossibleScore += q.points;
            });
            saveToLocalStorage(LS_TOTAL_SCORE_KEY, totalPossibleScore); // Save total score for this attempt

            // --- Display Questions and Collapsible Passages ---
            questions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.classList.add('quiz-question');
                questionElement.setAttribute('data-question-id', q.id);

                let passageHTML = '';
                let questionTextHTML = q.text;

                // Prepare passage HTML if needed
                 if (q.passageKey && readingPassages[q.passageKey]) {
                     const passageData = readingPassages[q.passageKey];
                     const passageId = `passage-content-${q.id}`;
                     questionTextHTML = `<span class="text-label">(По тексту '${passageData.title}')</span> ${q.text}`; // Add label
                     passageHTML = `
                        <div class="passage-toggle-container">
                            <button type="button" class="toggle-passage-btn" data-target="${passageId}">
                                <i class="fas fa-chevron-down"></i> Показать текст
                            </button>
                            <div id="${passageId}" class="passage-content">
                                <h4>${passageData.title}</h4>
                                <p>${passageData.text}</p>
                            </div>
                        </div>
                     `;
                 }

                let optionsHTML = '';
                const savedAnswer = answers[q.id]; // Get saved answer for this question

                if (q.type === 'multiple-choice') {
                    const optionLetters = ['A', 'B', 'C', 'D'];
                    optionsHTML = '<ul class="options-list">';
                    q.options.forEach((option, i) => {
                        const optionId = `q${q.id}_option${i}`;
                        const optionValue = optionLetters[i];
                        const isChecked = savedAnswer === optionValue; // Check if this option was saved
                        optionsHTML += `
                            <li>
                                <input type="radio" id="${optionId}" name="question_${q.id}" value="${optionValue}" required ${isChecked ? 'checked' : ''}>
                                <label for="${optionId}">${optionValue}) ${option}</label>
                            </li>
                        `;
                    });
                    optionsHTML += '</ul>';
                } else if (q.type === 'fill-in') {
                     const savedValue = savedAnswer || ''; // Get saved text or empty string
                     optionsHTML = `
                        <input type="text" id="q${q.id}_answer" name="question_${q.id}" class="fill-in-input" placeholder="Ваш ответ..." required value="${savedValue}">
                    `;
                } else if (q.type === 'matching') {
                     const savedMatches = typeof savedAnswer === 'string' ? JSON.parse(savedAnswer || '{}') : (savedAnswer || {}); // Parse saved matches
                     optionsHTML = '<div class="matching-container">';
                     optionsHTML += '<div class="matching-column"><strong>Персонаж:</strong><ul>';
                     Object.keys(q.items).forEach(item => {
                         optionsHTML += `<li>${item}</li>`;
                     });
                     optionsHTML += '</ul></div>';
                     optionsHTML += '<div class="matching-column"><strong>Характеристика:</strong><ul>';
                     Object.keys(q.items).forEach((item, index) => {
                         const selectId = `q${q.id}_match_${index}`;
                         const savedMatchValue = savedMatches[item] || '';
                         optionsHTML += `<li>
                             <select id="${selectId}" name="question_${q.id}_${index}" data-item="${item}" required>
                                 <option value="">Выберите...</option>`;
                         q.options.forEach(opt => {
                             const isSelected = savedMatchValue === opt;
                             optionsHTML += `<option value="${opt}" ${isSelected ? 'selected' : ''}>${opt}</option>`;
                         });
                         optionsHTML += `</select>
                         </li>`;
                     });
                     optionsHTML += '</ul></div></div>';
                 }

                questionElement.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Вопрос ${index + 1}</span>
                        <span class="question-points">${q.points.toLocaleString()} балла</span>
                    </div>
                    <p class="question-text">${questionTextHTML}</p>
                    ${passageHTML}
                    ${optionsHTML}
                `;
                quizContainer.appendChild(questionElement);
            });
             submitButton.disabled = false; // Enable submit button
        }

        // Function to handle quiz submission
        function submitQuiz(event) {
            event.preventDefault();
            currentAnswers = collectCurrentAnswers(); // Collect final answers
            let currentScore = 0;
            window.scrollTo(0, 0);

            selectedQuestions.forEach(q => {
                const questionId = q.id;
                let isCorrect = false;
                let userAnswerValue = currentAnswers[questionId]; // Get collected answer

                if (q.type === 'multiple-choice') {
                    isCorrect = userAnswerValue === q.correctAnswer;
                } else if (q.type === 'fill-in') {
                    isCorrect = typeof userAnswerValue === 'string' && typeof q.correctAnswer === 'string' && userAnswerValue.toLowerCase() === q.correctAnswer.toLowerCase();
                } else if (q.type === 'matching') {
                    let allMatchesCorrect = true;
                    const userMatchData = typeof userAnswerValue === 'string' ? JSON.parse(userAnswerValue || '{}') : (userAnswerValue || {});
                    Object.keys(q.items).forEach(item => {
                         if (!userMatchData[item] || userMatchData[item] !== q.correctAnswer[item]) {
                            allMatchesCorrect = false;
                        }
                    });
                    isCorrect = allMatchesCorrect;
                 }

                if (isCorrect) {
                    currentScore += q.points;
                }
            });

            // Save final state
            saveToLocalStorage(LS_STATE_KEY, 'completed');
            saveToLocalStorage(LS_ANSWERS_KEY, currentAnswers); // Save final answers
            saveToLocalStorage(LS_SCORE_KEY, currentScore);
            // totalPossibleScore should already be saved from loadQuizQuestionsUI

            displayResults(currentScore, currentAnswers); // Pass final answers to display
        }

        // Function to display results
        function displayResults(score, finalAnswers) {
            quizForm.classList.add('hidden');
            resultsContainer.classList.remove('hidden');

             const savedTotalScore = getFromLocalStorage(LS_TOTAL_SCORE_KEY) || totalPossibleScore || 0; // Use saved total score

             const formattedScore = score % 1 === 0 ? score : score.toFixed(1);
             const formattedTotal = savedTotalScore % 1 === 0 ? savedTotalScore : savedTotalScore.toFixed(1);

            scoreDisplay.textContent = `Ваш результат: ${formattedScore.toLocaleString()} / ${formattedTotal.toLocaleString()} баллов`;

            detailedResultsContainer.innerHTML = '';
            // Ensure selectedQuestions is populated (might need to reload if navigating directly to results)
             if (selectedQuestions.length === 0) {
                 const savedQuestionIds = getFromLocalStorage(LS_QUESTIONS_KEY);
                 if (savedQuestionIds) {
                     selectedQuestions = allVariant1Questions.filter(q => savedQuestionIds.includes(q.id));
                     // Re-sort based on saved order if needed, or just display in default order
                     // For simplicity, we'll use the filtered order.
                 } else {
                     detailedResultsContainer.innerHTML = "<p>Не удалось загрузить детализацию вопросов.</p>";
                     return;
                 }
             }


            selectedQuestions.forEach((q, index) => {
                const resultData = finalAnswers[q.id]; // Use the final answers passed to the function
                const isCorrect = checkCorrectness(q, resultData); // Check correctness based on final answer

                const resultElement = document.createElement('div');
                resultElement.classList.add('result-item');
                resultElement.classList.add(isCorrect ? 'correct' : 'incorrect');

                 let questionTextHTML = q.text;
                 if (q.passageKey && readingPassages[q.passageKey]) {
                     const passageTitle = readingPassages[q.passageKey].title;
                     questionTextHTML = `<span class="text-label">(По тексту '${passageTitle}')</span> ${q.text}`;
                 }


                let answerDetailsHTML = '';
                if (q.type === 'multiple-choice') {
                    const userAnswerText = resultData ? q.options[ ['A', 'B', 'C', 'D'].indexOf(resultData) ] : 'Нет ответа';
                    const correctAnswerText = q.options[ ['A', 'B', 'C', 'D'].indexOf(q.correctAnswer) ];
                     answerDetailsHTML = `
                        <p><strong>Ваш ответ:</strong> ${resultData ? `<span class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">${resultData}) ${userAnswerText}</span>` : 'Нет ответа'} ${isCorrect ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--danger);"></i>'}</p>
                        ${!isCorrect ? `<p><strong>Правильный ответ:</strong> <span class="correct-answer">${q.correctAnswer}) ${correctAnswerText}</span></p>` : ''}
                    `;
                } else if (q.type === 'fill-in') {
                     answerDetailsHTML = `
                        <p><strong>Ваш ответ:</strong> <span class="${isCorrect ? 'correct-answer' : 'incorrect-answer'}">${resultData || 'Нет ответа'}</span> ${isCorrect ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--danger);"></i>'}</p>
                        ${!isCorrect ? `<p><strong>Правильный ответ:</strong> <span class="correct-answer">${q.correctAnswer}</span></p>` : ''}
                    `;
                } else if (q.type === 'matching') {
                     const userMatchData = typeof resultData === 'string' ? JSON.parse(resultData || '{}') : (resultData || {});
                     answerDetailsHTML = '<p><strong>Ваши соответствия:</strong></p><ul>';
                     let correctMatchesHTML = '<p><strong>Правильные соответствия:</strong></p><ul>';
                     let isFullyCorrect = true; // Re-check based on final answers
                     Object.keys(q.items).forEach(item => {
                         const userChoice = userMatchData[item] || 'Нет ответа';
                         const correctChoice = q.correctAnswer[item];
                         const itemCorrect = userChoice === correctChoice;
                         if (!itemCorrect) isFullyCorrect = false;
                         answerDetailsHTML += `<li>${item} &rarr; <span class="${itemCorrect ? 'correct-answer' : 'incorrect-answer'}">${userChoice}</span> ${itemCorrect ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '<i class="fas fa-times" style="color: var(--danger);"></i>'}</li>`;
                         correctMatchesHTML += `<li>${item} &rarr; ${correctChoice}</li>`;
                     });
                     answerDetailsHTML += '</ul>';
                     correctMatchesHTML += '</ul>';
                     if (!isFullyCorrect) { // Use the re-checked flag
                         answerDetailsHTML += correctMatchesHTML;
                     }
                }


                resultElement.innerHTML = `
                    <div class="question-text"><strong>${index + 1}.</strong> ${questionTextHTML} (${q.points.toLocaleString()} балла)</div>
                    <div class="result-details">
                        ${answerDetailsHTML}
                    </div>
                `;
                detailedResultsContainer.appendChild(resultElement);
            });
        }

        // Helper function to check correctness based on question type and answer
        function checkCorrectness(question, userAnswer) {
             if (userAnswer === null || userAnswer === undefined) return false;

             if (question.type === 'multiple-choice') {
                 return userAnswer === question.correctAnswer;
             } else if (question.type === 'fill-in') {
                 return typeof userAnswer === 'string' && typeof question.correctAnswer === 'string' && userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
             } else if (question.type === 'matching') {
                 const userMatchData = typeof userAnswer === 'string' ? JSON.parse(userAnswer || '{}') : (userAnswer || {});
                 let allCorrect = true;
                 Object.keys(question.items).forEach(item => {
                     if (!userMatchData[item] || userMatchData[item] !== question.correctAnswer[item]) {
                         allCorrect = false;
                     }
                 });
                 return allCorrect;
             }
             return false;
         }


        // Helper function to collect current answers from the form
        function collectCurrentAnswers() {
            const answers = {};
            selectedQuestions.forEach(q => {
                 const questionId = q.id;
                 if (q.type === 'multiple-choice') {
                    const selectedOption = quizForm.querySelector(`input[name="question_${questionId}"]:checked`);
                    if (selectedOption) {
                        answers[questionId] = selectedOption.value;
                    } else {
                         answers[questionId] = null; // No answer selected
                    }
                } else if (q.type === 'fill-in') {
                     const inputElement = quizForm.querySelector(`input[name="question_${questionId}"]`);
                     answers[questionId] = inputElement ? inputElement.value.trim() : null;
                } else if (q.type === 'matching') {
                    const matchData = {};
                     let hasAnswer = false;
                    Object.keys(q.items).forEach((item, index) => {
                        const selectElement = quizForm.querySelector(`select[name="question_${questionId}_${index}"]`);
                        if (selectElement && selectElement.value) {
                             matchData[item] = selectElement.value;
                             hasAnswer = true;
                        } else {
                             matchData[item] = null;
                        }
                    });
                     // Only store if at least one match was made, otherwise treat as unanswered
                     answers[questionId] = hasAnswer ? JSON.stringify(matchData) : null;
                 }
            });
            return answers;
        }

        // Function to save answers progressively
        function saveProgress() {
            const currentAnswers = collectCurrentAnswers();
            saveToLocalStorage(LS_ANSWERS_KEY, currentAnswers);
             // Also update the state to ensure it remains 'in-progress'
             saveToLocalStorage(LS_STATE_KEY, 'in-progress');
        }


        // --- Initialization & Event Listeners ---
        window.addEventListener('load', () => {
            // Restore state on load
            const savedState = getFromLocalStorage(LS_STATE_KEY);
            const savedVariantId = getFromLocalStorage(LS_VARIANT_KEY);

            if (savedState === 'completed' && savedVariantId === '1') {
                 mainTitle.textContent = 'Миллий Сертификат - Результаты (Вариант 1)';
                 const savedAnswers = getFromLocalStorage(LS_ANSWERS_KEY);
                 const savedScore = getFromLocalStorage(LS_SCORE_KEY);
                 // selectedQuestions needs to be repopulated based on saved IDs
                 const savedQuestionIds = getFromLocalStorage(LS_QUESTIONS_KEY);
                 if (savedQuestionIds) {
                     selectedQuestions = allVariant1Questions.filter(q => savedQuestionIds.includes(q.id));
                 } else {
                      console.error("Cannot display results: saved question IDs not found.");
                      clearQuizState();
                      displayVariantSelection();
                      return;
                 }

                 if (savedAnswers && savedScore !== null) {
                     displayResults(savedScore, savedAnswers);
                 } else {
                      // If results data is incomplete, clear and go to selection
                      clearQuizState();
                      displayVariantSelection();
                 }

            } else if (savedState === 'in-progress' && savedVariantId === '1') {
                 mainTitle.textContent = 'Миллий Сертификат - Тест (Вариант 1)';
                 const savedAnswers = getFromLocalStorage(LS_ANSWERS_KEY) || {};
                 const savedQuestionIds = getFromLocalStorage(LS_QUESTIONS_KEY);

                 if (savedQuestionIds) {
                     // Filter the original pool to get the exact questions in the saved order/set
                     selectedQuestions = allVariant1Questions.filter(q => savedQuestionIds.includes(q.id));
                     // Optional: Reorder selectedQuestions based on savedQuestionIds if order matters
                     const questionMap = selectedQuestions.reduce((map, q) => { map[q.id] = q; return map; }, {});
                     selectedQuestions = savedQuestionIds.map(id => questionMap[id]).filter(q => q); // Filter out undefined if any mismatch

                     variantSelectionContainer.classList.add('hidden');
                     quizForm.classList.remove('hidden');
                     resultsContainer.classList.add('hidden');
                     loadQuizQuestionsUI(selectedQuestions, savedAnswers); // Load UI with saved questions and answers
                 } else {
                     // If question IDs are missing, clear and start over
                     clearQuizState();
                     displayVariantSelection();
                 }

            } else {
                // Default: show variant selection
                clearQuizState(); // Clear any inconsistent state
                displayVariantSelection();
            }
        });

        variantSelectionContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('variant-button')) {
                const variantId = event.target.getAttribute('data-variant');
                startQuiz(variantId);
            }
        });

        quizForm.addEventListener('submit', submitQuiz);

        retryButton.addEventListener('click', () => {
            clearQuizState(); // Clear saved state
            displayVariantSelection(); // Go back to selection screen
        });

        // Event listener for toggling passage visibility
        quizContainer.addEventListener('click', (event) => {
            const button = event.target.closest('.toggle-passage-btn');
            if (button) {
                const targetId = button.getAttribute('data-target');
                const content = document.getElementById(targetId);
                if (content) {
                    const isVisible = content.classList.contains('visible');
                    if (isVisible) {
                        content.classList.remove('visible');
                        button.innerHTML = '<i class="fas fa-chevron-down"></i> Показать текст';
                        button.classList.remove('expanded');
                    } else {
                        content.classList.add('visible');
                        button.innerHTML = '<i class="fas fa-chevron-up"></i> Скрыть текст';
                         button.classList.add('expanded');
                    }
                }
            }
        });

        // Event listener to save progress on input change
        quizContainer.addEventListener('change', (event) => {
             // Check if the change occurred within an input relevant to the quiz
             if (event.target.matches('input[type="radio"], input[type="text"], select')) {
                 saveProgress();
             }
         });
         // Also save on input for text fields for more immediate saving
         quizContainer.addEventListener('input', (event) => {
             if (event.target.matches('input[type="text"].fill-in-input')) {
                  // Could add debounce here if needed, but for simplicity saving directly
                  saveProgress();
             }
         });

    </script>
</body>
</html>
